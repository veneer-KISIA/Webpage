<!DOCTYPE html>
<html>
  <head>
    <title>Audio Recording and Upload</title>
  </head>

  <body>
    <h2>파일 다운로드</h2>
    <input type="text" id="fileNameInput" placeholder="파일 이름" />
    <button id="downloadButton">다운로드</button>

    <hr />

    <h2>오디오 녹음 및 전송</h2>
    <input type="text" name="fileName" placeholder="파일 이름 입력" />
    <button id="startRecord">녹음 시작</button>
    <button id="pauseRecord" disabled>일시정지</button>
    <button id="stopRecord" disabled>녹음 정지</button>
    <button id="upload" disabled>파일 전송</button>

    <ul id="audio-player"></ul>
    <ul id="messages"></ul>

    <h2>STT 결과:</h2>
    <div id="result"></div>

    <script>
      // 파일 다운로드
      const downloadButton = document.getElementById("downloadButton");
      downloadButton.addEventListener("click", async () => {
        const fileNameInput = document.getElementById("fileNameInput").value;
        if (!fileNameInput) {
          alert("파일 이름을 입력하세요.");
          return;
        }

        try {
          const response = await fetch(`/download/${fileNameInput}`);
          const blob = await response.blob();

          const a = document.createElement("a");
          const url = window.URL.createObjectURL(blob);
          a.href = url;
          a.download = fileNameInput;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          alert("파일 다운로드 에러:", error);
        }
      });

      // 오디오 관련 변수
      let mediaRecorder;
      let audioChunks = [];
      let isPaused = false;

      // 오디오 관련 버튼
      const startRecordButton = document.getElementById("startRecord");
      const pauseRecordButton = document.getElementById("pauseRecord");
      const stopRecordButton = document.getElementById("stopRecord");
      const uploadButton = document.getElementById("upload");
      const messages = document.getElementById("messages");

      // 결과 로그 출력 함수
      function log(msg) {
        const newMessageDiv = document.createElement("div");
        newMessageDiv.textContent = msg;
        messages.appendChild(newMessageDiv);
      }

      // 녹음 시작 버튼 클릭 이벤트
      startRecordButton.addEventListener("click", async () => {
        try {
          const clipboardUrl = await navigator.clipboard.readText();
          console.log(clipboardUrl);
          audioChunks.length = 0; // 이전의 audio chunks를 모두 삭제
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(stream);

          // 녹음기가 데이터를 받을 때마다 audioChunks에 저장
          mediaRecorder.addEventListener("dataavailable", (event) => {
            if (event.data.size > 0) {
              audioChunks.push(event.data);
            }
          });

          // 녹음기가 녹음을 멈추면 audioChunks를 하나의 Blob으로 만들고 오디오 플레이어에 추가
          mediaRecorder.addEventListener("stop", () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/*" });
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            audio.controls = true;

            fileName = document.querySelector('input[name="fileName"]').value;
            playerlist = document.getElementById("audio-player");

            // 기존 자식 요소 삭제
            while (playerlist.firstChild) {
              playerlist.removeChild(playerlist.firstChild);
            }

            const audioContainer = document.createElement("div");
            audioContainer.appendChild(audio);

            const fileNameElement = document.createElement("span");
            fileNameElement.textContent = ` (${fileName})`;
            audioContainer.appendChild(fileNameElement);
            playerlist.appendChild(audioContainer);

            uploadButton.disabled = false;
          });

          mediaRecorder.start();
          startRecordButton.disabled = true;
          pauseRecordButton.disabled = false;
          stopRecordButton.disabled = false;
        } catch (error) {
          log("마이크로폰 관련 에러:", error);
        }
      });

      // 일시정지 버튼 클릭 이벤트
      pauseRecordButton.addEventListener("click", () => {
        if (!isPaused) {
          mediaRecorder.pause();
          isPaused = true;
          pauseRecordButton.textContent = "재개";
        } else {
          mediaRecorder.resume();
          isPaused = false;
          pauseRecordButton.textContent = "일시정지";
        }
      });

      // 녹음 정지 버튼 클릭 이벤트
      stopRecordButton.addEventListener("click", () => {
        mediaRecorder.stop();
        startRecordButton.disabled = false;
        pauseRecordButton.disabled = true;
        stopRecordButton.disabled = true;
      });

      // 파일 전송 버튼 클릭 이벤트
      uploadButton.addEventListener("click", async () => {
        // 파일 이름 가져오기
        fileNameInput = document.querySelector('input[name="fileName"]');
        const audioBlob = new Blob(audioChunks, { type: "audio/*" });
        const formData = new FormData();
        formData.append("audio", audioBlob, fileNameInput.value);

        let content = "";
        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();
          content = data.message + ` (${data.fileName})`;
        } catch (error) {
          const newMessageDiv = document.createElement("div");
          content = fileNameInput.value + " 파일 업로드 에러: " + error;
        } finally {
          log(content);
        }
      });

      // 서버에서 STT 결과를 가져오는 함수
      function fetchSTTResult() {
        // 서버로부터 STT 결과를 가져옵니다. 여기서 서버 URL을 적절하게 변경해야 합니다.
        fetch("/get_stt_result")
          .then((response) => response.json())
          .then((data) => {
            // 결과를 result div에 표시합니다.
            document.getElementById("result").innerText = data.STT;
          })
          .catch((error) => {
            console.error("STT 결과 가져오기 실패:", error);
          });
      }
      // 페이지가 로드될 때 STT 결과를 가져옵니다.
      window.onload = fetchSTTResult;
    </script>
  </body>
</html>
